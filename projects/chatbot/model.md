#Model Documentation

## 1. Introduction

This document provides a comprehensive overview of the database models used in this project. These models, defined using SQLAlchemy, form the data persistence layer of the application. The models are organized into modules based on their functionality: `auth`, `dashboard`, and `workforce`.

## 2. Base Models

The application utilizes base models to ensure consistency and provide common functionality across all data models.

### 2.1. `src.model.base.BaseModel`

This is the primary base model for most of the tables in the `auth` and `dashboard` schemas.

**Fields:**

| Column | Type | Description |
|---|---|---|
| `id` | String(50) | Primary key, a unique UUID for the record. |
| `created_at` | DateTime | Timestamp of when the record was created (UTC). |
| `updated_at` | DateTime | Timestamp of when the record was last updated (UTC). |

### 2.2. `src.core.database.BaseModel`

This base model is used by the `workforce` models and is imported from `src.core.database`. It is expected to provide similar base functionality.

## 3. Authentication Models (`auth/`)

These models are responsible for user authentication and managing integrations with third-party services.

### 3.1. `User`

Stores information about users, their roles, and authentication details.

**Fields:**

| Column | Type | Description |
|---|---|---|
| `email` | String(255) | The user's email address. Must be unique. |
| `display_name` | String(255) | The user's display name. |
| `role` | String(50) | The user's role (e.g., "NORMAL"). |
| `last_login` | DateTime | Timestamp of the user's last login. |
| `refresh_token` | String | Refresh token for session management. |
| `third_party_refresh_token` | String | Refresh token from a third-party provider. |
| `token_expiry` | Float | Expiration timestamp for the access token. |
| `tutorials_completed` | JSON | A JSON object tracking the user's progress through various application tutorials. |

### 3.2. `IntegrationAuth`

Stores authentication tokens for third-party integrations.

**Fields:**

| Column | Type | Description |
|---|---|---|
| `user_id` | String(50) | The ID of the user associated with this integration. |
| `access_token` | String | The access token for the third-party service. |
| `refresh_token` | String | The refresh token for the third-party service. |
| `token_expiry` | Float | The expiration timestamp for the access token. |
| `provider` | String | The name of the third-party provider (e.g., "google", "microsoft"). |

## 4. Dashboard Models (`dashboard/`)

These models store data for analytics, performance metrics, and recommendations presented on the dashboard.

### 4.1. `ChatbotAnalytics`

Tracks user interactions with chatbots for analytical purposes.

**Fields:**

| Column | Type | Description |
|---|---|---|
| `id` | String(50) | Unique identifier for the interaction. |
| `agent_id` | String(255) | The ID of the agent that handled the interaction. |
| `query` | Text | The query sent by the user. |
| `response` | Text | The response provided by the agent. |
| `is_liked` | Boolean | `True` if the user liked the response, `False` otherwise. |
| `user_email` | String(255) | The email of the user who initiated the interaction. |
| `created_at` | DateTime | Timestamp of when the interaction was created. |
| `updated_at` | DateTime | Timestamp of when the interaction was last updated. |

### 4.2. `AgentPerformanceMetrics`

Stores performance metrics for each agent.

**Fields:**

| Column | Type | Description |
|---|---|---|
| `query_id` | String(50) | Unique identifier for the query. |
| `agent_id` | String(255) | The ID of the agent. |
| `query` | Text | The query processed by the agent. |
| `response` | Text | The response generated by the agent. |
| `response_time` | Float | The time taken by the agent to generate a response, in seconds. |
| `department` | Text | The department associated with the agent. |
| `created_at` | DateTime | Timestamp of when the metric was recorded. |
| `updated_at` | DateTime | Timestamp of when the metric was last updated. |

### 4.3. `TopicRegistry`

Maintains a registry of topics identified in user queries.

**Fields:**

| Column | Type | Description |
|---|---|---|
| `id` | String(50) | Unique identifier for the topic. |
| `agent_id` | String(255) | The ID of the agent that identified the topic. |
| `topic_name` | String(500) | The name of the topic. |
| `growth_count` | Integer | The number of times this topic has been mentioned. |
| `department` | Text | The department associated with the topic. |
| `status` | String(50) | The status of the topic (e.g., "Active"). |
| `first_seen` | DateTime | Timestamp of when the topic was first seen. |
| `last_seen` | DateTime | Timestamp of when the topic was last seen. |
| `created_at` | DateTime | Timestamp of when the topic was created. |
| `updated_at` | DateTime | Timestamp of when the topic was last updated. |

### 4.4. `RecommendationAlert`

Stores alerts and recommendations for system improvement.

**Fields:**

| Column | Type | Description |
|---|---|---|
| `id` | String(50) | Unique identifier for the alert. |
| `agent_id` | String(255) | The ID of the agent related to the alert. |
| `department` | Text | The department associated with the alert. |
| `title` | String(500) | The title of the recommendation or alert. |
| `description` | Text | A detailed description of the recommendation. |
| `type` | String(100) | The type of recommendation (e.g., "knowledge_base", "response_time"). |
| `priority` | String(50) | The priority of the alert (e.g., "Urgent", "High"). |
| `status` | String(50) | The status of the alert (e.g., "Open", "Resolved"). |
| `created_at` | DateTime | Timestamp of when the alert was created. |

## 5. Workforce Models (`workforce/`)

These models support the workforce application builder, allowing users to create and manage their own applications (agents).

### 5.1. `Apps`

The central model representing an application created by a user.

**Fields:**

| Column | Type | Description |
|---|---|---|
| `email` | String(50) | The email of the user who created the app. |
| `app_id` | String(50) | Unique identifier for the app. |
| `app_name` | String(50) | The name of the app. |
| `description` | String(255) | A description of the app. |
| `logo` | Text | A URL or base64-encoded string for the app's logo. |
| `created_at` | DateTime | Timestamp of when the app was created. |
| `updated_at` | DateTime | Timestamp of when the app was last updated. |

**Relationships:**
- Has one-to-many relationships with `AppDocuments`, `AppContainers`, `AppDataSources`, and `AppTools`.
- Has a one-to-one relationship with `AppInstructions`, `AppTriggers`, `PublishedApps`, and `AgentState`.

### 5.2. `AppDocuments`

Represents documents from SharePoint that are associated with an app.

**Fields:**

| Column | Type | Description |
|---|---|---|
| `id` | String(50) | Unique identifier for the document record. |
| `app_id` | String(50) | Foreign key to the `Apps` table. |
| `file_name` | String(255) | The name of the file. |
| `file_path` | String(500) | The path to the file in SharePoint. |
| `file_id` | String(255) | The ID of the file in SharePoint. |
| `drive_id` | String(255) | The ID of the drive in SharePoint. |
| `selected_at` | DateTime | Timestamp of when the file was selected. |
| `selected_by` | String(255) | The email of the user who selected the file. |

### 5.3. `AppContainers`

Represents SharePoint folders associated with an app.

**Fields:**

| Column | Type | Description |
|---|---|---|
| `id` | String(50) | Unique identifier for the container record. |
| `app_id` | String(50) | Foreign key to the `Apps` table. |
| `folder_name` | String(255) | The name of the folder. |
| `folder_path` | String(500) | The path to the folder in SharePoint. |
| `folder_id` | String(255) | The ID of the folder in SharePoint. |
| `drive_id` | String(255) | The ID of the drive in SharePoint. |
| `selected_at` | DateTime | Timestamp of when the folder was selected. |
| `selected_by` | String(255) | The email of the user who selected the folder. |

### 5.4. `AppDataSources`

Defines the data sources for an app.

**Fields:**

| Column | Type | Description |
|---|---|---|
| `id` | String(50) | Unique identifier for the data source record. |
| `app_id` | String(50) | Foreign key to the `Apps` table. |
| `source_type` | String(50) | The type of data source (e.g., "sharepoint"). |
| `access_level` | String(50) | The level of access granted to the data source (e.g., "root"). |
| `selected_at` | DateTime | Timestamp of when the data source was selected. |
| `selected_by` | String(255) | The email of the user who selected the data source. |

### 5.5. `AppInstructions`

Stores the instructional prompts for an app's agent.

**Fields:**

| Column | Type | Description |
|---|---|---|
| `id` | String(50) | Unique identifier for the instruction record. |
| `app_id` | String(50) | Foreign key to the `Apps` table. |
| `instruction` | Text | The instruction text for the agent. |
| `created_at` | DateTime | Timestamp of when the instruction was created. |
| `updated_at` | DateTime | Timestamp of when the instruction was last updated. |

### 5.6. `AppTriggers`

Defines the triggers that activate an app's agent.

**Fields:**

| Column | Type | Description |
|---|---|---|
| `id` | String(50) | Unique identifier for the trigger record. |
| `app_id` | String(50) | Foreign key to the `Apps` table. |
| `trigger_type` | String(50) | The type of trigger ("conversational" or "time_based"). |
| `prompt` | Text | The prompt for conversational triggers. |
| `recurrence` | String(50) | The recurrence for time-based triggers ("daily", "weekly", "monthly"). |
| `start_date` | Date | The start date for time-based triggers. |
| `start_time` | Time | The start time for time-based triggers. |
| `created_at` | DateTime | Timestamp of when the trigger was created. |
| `updated_at` | DateTime | Timestamp of when the trigger was last updated. |

### 5.7. `AppTools`

Represents the tools enabled for an app.

**Fields:**

| Column | Type | Description |
|---|---|---|
| `id` | String(50) | Unique identifier for the tool record. |
| `app_id` | String(50) | Foreign key to the `Apps` table. |
| `tool_type` | String(50) | The type of tool enabled. |
| `selected_at` | DateTime | Timestamp of when the tool was selected. |

### 5.8. `PublishedApps`

Stores the publishing status and visibility of an app.

**Fields:**

| Column | Type | Description |
|---|---|---|
| `id` | String(50) | Unique identifier for the publishing record. |
| `app_id` | String(50) | Foreign key to the `Apps` table. |
| `visibility` | Enum | The visibility of the app ("private", "team", "public", etc.). |
| `published_at` | DateTime | Timestamp of when the app was published. |
| `published_by` | String(255) | The email of the user who published the app. |
| `allowed_teammates` | String(1000) | A comma-separated list of emails for "specific_teammates" visibility. |
| `iframe_params` | JSON | JSON object containing parameters for embedding the app in an iframe. |

### 5.9. `AgentState`

Maintains the state of an app's agent.

**Fields:**

| Column | Type | Description |
|---|---|---|
| `id` | String(50) | Unique identifier for the agent state record. |
| `app_id` | String(50) | Foreign key to the `Apps` table. |
| `agent_type` | String(50) | The type of the agent. |
| `conversation_history` | JSON | A list of previous conversation messages. |
| `custom_prompt` | Text | A custom prompt for the agent. |
| `trigger_documents` | Text | Documents that can trigger the agent. |
| `container_name` | String(255) | The name of the container used by the agent. |
| `database_name` | String(255) | The name of the database used by the agent. |
| `document_cont_id` | String(255) | The ID of the document container. |
| `created_at` | DateTime | Timestamp of when the agent state was created. |
| `updated_at` | DateTime | Timestamp of when the agent state was last updated. |

### 5.10. `AppLocalFiles`

Stores files uploaded directly to the application.

**Fields:**

| Column | Type | Description |
|---|---|---|
| `id` | String(50) | Unique identifier for the file record. |
| `app_id` | String(50) | Foreign key to the `Apps` table. |
| `file_name` | String(255) | The name of the uploaded file. |
| `file_size` | BigInteger | The size of the file in bytes. |
| `content_type` | String(100) | The MIME type of the file. |
| `file_extension` | String(10) | The file extension. |
| `file_hash` | String(32) | The MD5 hash of the file content. |
| `file_content` | LargeBinary | The binary content of the file. |
| `uploaded_by` | String(255) | The email of the user who uploaded the file. |
| `is_active` | Boolean | `True` if the file is currently active and used by the app. |
| `selected_at` | DateTime | Timestamp of when the file was selected. |
| `created_at` | DateTime | Timestamp of when the file was created. |
| `updated_at` | DateTime | Timestamp of when the file was last updated. |

### 5.11. `MessageStatus`

Tracks the processing status of messages for asynchronous operations.

**Fields:**

| Column | Type | Description |
|---|---|---|
| `id` | String(50) | Unique identifier for the message status record. |
| `correlation_id` | String(100) | A unique ID to correlate messages across services. |
| `user_id` | String(100) | The ID of the user who sent the message. |
| `app_id` | String(50) | Foreign key to the `Apps` table. |
| `status` | String(20) | The processing status ("queued", "processing", "completed", "failed"). |
| `response_summary` | Text | A brief summary of the response for UI display. |
| `error_message` | String(500) | A user-friendly error message if processing failed. |
| `created_at` | DateTime | Timestamp of when the message was created. |
| `updated_at` | DateTime | Timestamp of when the message status was last updated. |
| `completed_at` | DateTime | Timestamp of when the message processing was completed. |
| `processing_time_seconds` | Integer | The total time taken to process the message, in seconds. |

**Methods:**
- `to_dict()`: Converts the model instance to a dictionary for API responses.
- `is_completed`: A property that returns `True` if the status is "completed".
- `is_failed`: A property that returns `True` if the status is "failed".
