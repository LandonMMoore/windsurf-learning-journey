# Middleware Documentation

This document provides a detailed explanation of the middleware used in this project. Middleware functions are crucial for processing incoming requests, handling authentication, logging, and shaping responses.

## Table of Contents
1.  [DashboardAuthMiddleware](#dashboardauthmiddleware)
    -   [Purpose](#purpose)
    -   [Monitored Endpoints](#monitored-endpoints)
    -   [Functionality](#functionality)
        -   [Pre-Request Checks](#pre-request-checks)
        -   [Post-Request Error Handling](#post-request-error-handling)
    -   [Error Responses](#error-responses)
        -   [401 - Missing Authorization Header](#401---missing-authorization-header)
        -   [401 - Invalid Authorization Format](#401---invalid-authorization-format)
        -   [401 - Authentication Failed](#401---authentication-failed)
        -   [403 - Insufficient Permissions](#403---insufficient-permissions)
2.  [ServiceAccountMiddleware](#serviceaccountmiddleware)
    -   [Purpose](#purpose-1)
    -   [Functionality](#functionality-1)
    -   [Configuration](#configuration)

---

## DashboardAuthMiddleware

### Purpose

The `DashboardAuthMiddleware` is a FastAPI middleware designed to enhance the authentication process for specific dashboard-related analytics endpoints. Its primary role is to intercept requests to these endpoints, validate the presence and format of the `Authorization` header, and provide clear, helpful error messages when authentication issues occur. This helps front-end developers and API consumers quickly diagnose and fix authentication problems.

### Monitored Endpoints

This middleware specifically targets the following analytics endpoints that are commonly accessed by the dashboard:

```
/api/v1/analytics/agent/
/api/v1/analytics/performance
/api/v1/analytics/heatmap
/api/v1/analytics/apps/emerging-topic
/api/v1/analytics/apps/query-forecasting
/api/v1/analytics/apps/topic-evolution
```

### Functionality

The middleware operates in two main phases: before the request is processed by the endpoint (pre-request) and after the endpoint has processed the request (post-request).

#### Pre-Request Checks

Before passing the request to the actual endpoint, the middleware performs the following checks on any request whose path starts with one of the `DASHBOARD_ENDPOINTS`:

1.  **Authorization Header Existence**: It checks if the `Authorization` header is present. If not, it immediately returns a `401 Unauthorized` response.
2.  **Authorization Header Format**: It verifies that the `Authorization` header value starts with `"Bearer "`. If the format is incorrect, it returns a `401 Unauthorized` response.

If both checks pass, the request proceeds to the next middleware or the endpoint itself.

#### Post-Request Error Handling

After the endpoint has processed the request, the middleware inspects the outgoing response:

1.  **401 Unauthorized Handling**: If the response status code is `401`, it signifies that the token (though present and well-formatted) is invalid, expired, or otherwise rejected by the core authentication logic. The middleware replaces the original response with a more detailed JSON response, guiding the user on how to resolve the issue.
2.  **403 Forbidden Handling**: If the response status code is `403`, it means the user is authenticated but does not have the necessary permissions (e.g., `ADMIN` or `SUPER_ADMIN` role) to access the resource. The middleware enriches the error response with context-specific information, including the `agent_id` if present in the URL, and suggests a solution.

### Error Responses

Below are the detailed structures of the JSON responses generated by this middleware.

#### 401 - Missing Authorization Header

-   **Status Code**: `401`
-   **Trigger**: The `Authorization` header is not included in the request.
-   **Payload**:
    ```json
    {
      "detail": "Authentication required for dashboard access",
      "error_code": "MISSING_AUTH_HEADER",
      "help": "Include 'Authorization: Bearer <token>' header in your request",
      "debug_endpoint": "/api/v1/auth-debug/check-token",
      "docs": "/dashboard_auth_fix_guide.md"
    }
    ```

#### 401 - Invalid Authorization Format

-   **Status Code**: `401`
-   **Trigger**: The `Authorization` header does not start with `"Bearer "`.
-   **Payload**:
    ```json
    {
      "detail": "Invalid authorization format",
      "error_code": "INVALID_AUTH_FORMAT",
      "help": "Authorization header must be in format 'Bearer <token>'",
      "received_format": "some-prefix...",
      "debug_endpoint": "/api/v1/auth-debug/check-token"
    }
    ```

#### 401 - Authentication Failed

-   **Status Code**: `401`
-   **Trigger**: The request was rejected by the downstream authentication logic (e.g., token is expired or invalid).
-   **Payload**:
    ```json
    {
      "detail": "Authentication failed",
      "error_code": "AUTH_FAILED",
      "possible_causes": [
        "Token expired - use /api/v1/auth/refresh to get new token",
        "Invalid token - re-authenticate with /api/v1/auth/login",
        "User lacks required permissions - need ADMIN or SUPER_ADMIN role"
      ],
      "debug_endpoint": "/api/v1/auth-debug/check-token",
      "help": "Check token validity and user role using debug endpoint"
    }
    ```

#### 403 - Insufficient Permissions

-   **Status Code**: `403`
-   **Trigger**: The user is authenticated but lacks the required role for dashboard access.
-   **Payload**:
    ```json
    {
      "detail": "Access denied",
      "error_code": "INSUFFICIENT_PERMISSIONS",
      "agent_id": "some-agent-id" | null,
      "help": "User authenticated but lacks permission. Dashboard requires ADMIN or SUPER_ADMIN role.",
      "debug_endpoint": "/api/v1/auth-debug/test-analytics-access/some-agent-id" | "/api/v1/auth-debug/check-token",
      "solution": "Login with an admin account or request admin privileges"
    }
    ```

---

## ServiceAccountMiddleware

### Purpose

The `ServiceAccountMiddleware` provides a way for internal systems or services (like a data analytics pipeline or a monitoring tool) to authenticate with the API using a service account token instead of a standard user JWT. This is a common pattern for machine-to-machine (M2M) communication.

### Functionality

This middleware inspects every incoming request for a special header: `X-Service-Token`.

1.  **Token Check**: It extracts the value of the `X-Service-Token` header.
2.  **Token Validation**: It checks if the provided token exists as a key in its internal `service_accounts` dictionary.
3.  **Authentication Injection**: If the token is valid, the middleware retrieves the corresponding service account information, which includes a pre-generated JWT (`jwt_token`). It then **injects** this JWT into the `Authorization` header of the request, formatted as a Bearer token.

This process allows the service account to seamlessly authenticate with the rest of the application's standard authentication system, which expects a `Bearer` token in the `Authorization` header. The downstream endpoints can then authorize the service based on the role embedded in its JWT.

A log entry is created to record which service account accessed a particular endpoint.

### Configuration

The middleware is initialized with a dictionary of service account tokens. In a production environment, this configuration should be loaded securely from environment variables or a secret management system.

-   **`service_account_tokens`** (dict): A dictionary where keys are the service tokens (sent in the `X-Service-Token` header) and values are dictionaries containing service account details.

**Example Configuration:**

```python
# This dictionary would be passed to the middleware upon initialization
service_tokens = {
    "secret-dashboard-token-xyz": {
        "name": "DashboardService",
        "jwt_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." # A valid JWT for this service
    },
    "secret-reporting-token-123": {
        "name": "ReportingService",
        "jwt_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." # A valid JWT for this service
    }
}

# In your FastAPI application setup:
# app.add_middleware(ServiceAccountMiddleware, service_account_tokens=service_tokens)
```
